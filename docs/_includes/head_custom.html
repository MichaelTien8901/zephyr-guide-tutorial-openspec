<!-- Mermaid diagrams with paper-like background -->
<style>
  /* Mermaid container - paper-like background */
  .mermaid,
  pre.mermaid,
  .language-mermaid,
  code.language-mermaid {
    background-color: #d5d0c8 !important;
    border-radius: 8px !important;
    padding: 16px !important;
    margin: 16px 0 !important;
    display: block !important;
  }

  /* All text in Mermaid - dark gray */
  .mermaid text,
  .mermaid tspan,
  .mermaid .nodeLabel,
  .mermaid .label,
  .mermaid .edgeLabel,
  .mermaid .cluster-label,
  .mermaid .messageText,
  .mermaid .loopText,
  .mermaid .noteText,
  .mermaid .labelText,
  .mermaid .actor {
    fill: #2c3e50 !important;
    color: #2c3e50 !important;
  }

  /* All lines and arrows - dark gray */
  .mermaid path,
  .mermaid line,
  .mermaid .edgePath path,
  .mermaid .flowchart-link,
  .mermaid .messageLine0,
  .mermaid .messageLine1,
  .mermaid .relation {
    stroke: #4a5568 !important;
  }

  /* Sequence diagram lifelines - force black color with max specificity */
  .mermaid line[stroke="#999"],
  .mermaid line[stroke="#999999"],
  .mermaid svg line[stroke="#999"],
  .mermaid svg line[stroke="#999999"],
  pre.mermaid line[stroke="#999"],
  div.mermaid line[stroke="#999"],
  .mermaid[data-processed="true"] line[stroke="#999"],
  .mermaid svg g line {
    stroke: #000000 !important;
  }

  /* Sequence diagram message lines */
  .mermaid .messageText {
    fill: #2c3e50 !important;
  }

  .mermaid .messageLine0,
  .mermaid .messageLine1 {
    stroke: #4a5568 !important;
    stroke-width: 1.5px !important;
  }

  .mermaid marker path,
  .mermaid .arrowheadPath {
    fill: #4a5568 !important;
    stroke: #4a5568 !important;
  }

  /* Node backgrounds - paper tones */
  .mermaid .node rect,
  .mermaid .node circle,
  .mermaid .node ellipse,
  .mermaid .node polygon,
  .mermaid .node path {
    fill: #c5c0b8 !important;
    stroke: #8a8578 !important;
  }

  /* Cluster backgrounds */
  .mermaid .cluster rect {
    fill: #cac5bd !important;
    stroke: #8a8578 !important;
  }

  /* Actor boxes in sequence diagrams */
  .mermaid .actor-box,
  .mermaid rect.actor {
    fill: #c5c0b8 !important;
    stroke: #8a8578 !important;
  }

  /* Notes - slightly warmer */
  .mermaid .note {
    fill: #ddd8c8 !important;
    stroke: #a89878 !important;
  }

  /* Mindmap nodes */
  .mermaid .mindmap-node rect,
  .mermaid .mindmap-node circle {
    fill: #c5c0b8 !important;
    stroke: #8a8578 !important;
  }

  .mermaid .mindmap-edges path {
    stroke: #4a5568 !important;
    stroke-width: 2px !important;
  }
</style>

<!-- Mermaid configuration for sequence diagrams -->
<script type="module">
  const mermaidConfig = {
    startOnLoad: true,
    theme: 'base',
    themeVariables: {
      background: '#d5d0c8',
      primaryColor: '#c5c0b8',
      primaryTextColor: '#2c3e50',
      primaryBorderColor: '#8a8578',
      lineColor: '#4a5568',
      textColor: '#2c3e50',
      // Sequence diagram specific
      actorBkg: '#c5c0b8',
      actorBorder: '#8a8578',
      actorTextColor: '#2c3e50',
      actorLineColor: '#4a5568',
      signalColor: '#4a5568',
      signalTextColor: '#2c3e50',
      noteBkgColor: '#ddd8c8',
      noteBorderColor: '#a89878',
      noteTextColor: '#2c3e50',
      sequenceNumberColor: '#2c3e50'
    },
    sequence: {
      actorMargin: 50,
      showSequenceNumbers: false,
      useMaxWidth: true
    }
  };

  // Wait for mermaid to be available and re-initialize
  if (typeof mermaid !== 'undefined') {
    mermaid.initialize(mermaidConfig);
  } else {
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof mermaid !== 'undefined') {
        mermaid.initialize(mermaidConfig);
      }
    });
  }

  // Fix lifeline colors after mermaid renders
  function fixLifelineColors() {
    document.querySelectorAll('.mermaid svg line').forEach(function(line) {
      // Force black stroke on ALL lines in sequence diagrams
      line.setAttribute('stroke', '#000000');
      line.style.stroke = '#000000';
    });
  }

  // Run multiple times to catch async rendering
  window.addEventListener('load', function() {
    setTimeout(fixLifelineColors, 100);
    setTimeout(fixLifelineColors, 500);
    setTimeout(fixLifelineColors, 1000);
    setTimeout(fixLifelineColors, 2000);
    setTimeout(fixLifelineColors, 3000);
  });

  // Also use MutationObserver to catch dynamically rendered diagrams
  const observer = new MutationObserver(function(mutations) {
    setTimeout(fixLifelineColors, 50);
    setTimeout(fixLifelineColors, 200);
  });

  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.mermaid').forEach(function(el) {
      observer.observe(el, { childList: true, subtree: true });
    });
    setTimeout(fixLifelineColors, 100);
  });
</script>
